#!/usr/bin/env bash
set -euo pipefail

print_help() {
  cat <<EOF
Usage:
  ./finished <problem_number> <folder>

Example:
  ./finished 12186 BOJ

Behavior:
  1. 현재 디렉토리에 .cpp 파일이 정확히 1개 있어야 합니다.
  2. 해당 파일을 <folder>/<problem_number>/main.cpp 로 이동합니다.
  3. *.in, *.out 파일을 같은 디렉토리로 이동합니다.
  4. README.md 를 생성합니다.
  5. template/main.cpp 를 루트 디렉토리의 main.cpp 로 복사합니다.
EOF
}

# 도움말
if [ "$#" -eq 0 ]; then
  print_help
  exit 0
fi

if [ "$#" -ne 2 ]; then
  echo "Error: Invalid arguments."
  echo
  print_help
  exit 1
fi

PROBLEM="$1"
ROOT_DIR="$2"
TARGET_DIR="${ROOT_DIR}/${PROBLEM}"

# 1. cpp 파일 검사
CPP_FILES=(*.cpp)

if [ "${CPP_FILES[0]}" = "*.cpp" ]; then
  echo "Error: No .cpp file found."
  exit 1
fi

if [ "${#CPP_FILES[@]}" -ne 1 ]; then
  echo "Error: Multiple .cpp files found:"
  printf ' - %s\n' "${CPP_FILES[@]}"
  exit 1
fi

ORIGINAL_CPP="${CPP_FILES[0]}"

# 2. 대상 디렉토리 생성
mkdir -p "${TARGET_DIR}"

# 3. 정답 cpp → 문제 폴더로 이동 + rename
mv "${ORIGINAL_CPP}" "${TARGET_DIR}/main.cpp"

# 4. *.in, *.out 이동
shopt -s nullglob
for f in *.in *.out; do
  mv "$f" "${TARGET_DIR}/"
done
shopt -u nullglob

# 5. README.md 생성
cat > "${TARGET_DIR}/README.md" <<EOF
# ${PROBLEM}

https://www.acmicpc.net/problem/${PROBLEM}
EOF

# 6. template/main.cpp → 루트 main.cpp
if [ ! -f template/main.cpp ]; then
  echo "Error: template/main.cpp not found."
  exit 1
fi

cp template/main.cpp main.cpp

echo "Finished setup for problem ${PROBLEM}"
